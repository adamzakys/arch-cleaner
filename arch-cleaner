#!/bin/bash

# --- [ CONFIGURATION ] ---
COLOR_PRI="4" # Blue
COLOR_SEC="2" # Green
COLOR_ERR="1" # Red

# --- [ SYSTEM CHECK ] ---
HOSTNAME=$(cat /etc/hostname)
KERNEL=$(uname -r)

# Detect Helper
if command -v paru &> /dev/null; then HELPER="paru"
elif command -v yay &> /dev/null; then HELPER="yay"
else HELPER="sudo pacman"; fi

# Ensure Dependencies
for dep in gum bc; do
    if ! command -v $dep &> /dev/null; then
        echo "Installing core dependency: $dep..."
        $HELPER -S $dep --noconfirm > /dev/null 2>&1
    fi
done

# --- [ VISUAL FUNCTIONS ] ---

get_bar() {
    local percent=$1
    local width=15
    local fill=$(echo "$percent * $width / 100" | bc)
    local empty=$((width - fill))
    
    local color=$COLOR_SEC
    if [ "$percent" -ge 75 ]; then color="3"; fi
    if [ "$percent" -ge 90 ]; then color=$COLOR_ERR; fi

    local filled_bar=$(printf "â– %.0s" $(seq 1 $fill))
    local empty_bar=$(printf "â–¡%.0s" $(seq 1 $empty))
    
    gum style --foreground "$color" "[$filled_bar$empty_bar]"
}

render_interface() {
    clear
    TERM_WIDTH=$(tput cols)
    
    # Gathering Data
    UPTIME=$(uptime -p | sed 's/up //')
    CPU_VAL=$(grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {print usage}' | cut -d. -f1)
    MEM_TOTAL=$(free -m | awk '/^Mem:/ {print $2}')
    MEM_USED=$(free -m | awk '/^Mem:/ {print $3}')
    MEM_PERC=$(( 100 * $MEM_USED / MEM_TOTAL ))
    DISK_VAL=$(df / | awk 'NR==2 {print $5}' | tr -d '%')
    
    CPU_BAR=$(get_bar $CPU_VAL)
    MEM_BAR=$(get_bar $MEM_PERC)
    DISK_BAR=$(get_bar $DISK_VAL)

    # Layout Logic
    if [ "$TERM_WIDTH" -gt 70 ]; then
        INFO_PANEL=$(gum style --width 32 --padding "0 1" --border rounded --border-foreground 8 \
            "ðŸ’» HOST IDENTITY" \
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" \
            "Hostname : $HOSTNAME" \
            "Kernel   : $KERNEL" \
            "Pkg Mgr  : $HELPER" \
            "Runtime  : $UPTIME")

        STATS_PANEL=$(gum style --width 32 --padding "0 1" --border rounded --border-foreground 8 \
            "ðŸ“Š TELEMETRY" \
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" \
            "CPU Load  : $CPU_BAR" \
            "RAM Usage : $MEM_BAR" \
            "Disk Root : $DISK_BAR")

        gum style --foreground $COLOR_PRI --border double --align center --width 66 --bold "SYSTEM CONTROL CENTER"
        gum join --horizontal "$INFO_PANEL" "  " "$STATS_PANEL"
    else
        # Safe Mode Layout (Jika terminal sempit)
        echo "SYSTEM CONTROL CENTER ($HOSTNAME)"
        echo "CPU: $CPU_BAR  RAM: $MEM_BAR"
        echo "---------------------------------"
    fi
}

# --- [ MODULES ] ---

mod_maintenance() {
    gum style --foreground $COLOR_PRI "âš™ EXECUTING CORE MAINTENANCE..."
    if [ "$HELPER" = "sudo pacman" ]; then
        ORPHANS=$(pacman -Qtdq)
        [ -n "$ORPHANS" ] && sudo pacman -Rns $ORPHANS
    else
        $HELPER -c || true
    fi
    $HELPER -Sc
    sudo journalctl --vacuum-time=2weeks
    rm -rf ~/.cache/*
    gum style --foreground $COLOR_SEC "âœ” Maintenance Complete."
    sleep 1
}

mod_sandbox() {
    gum style --foreground $COLOR_PRI "ðŸ“¦ SANDBOX MANAGER"
    # Tambahkan < /dev/tty di sini juga untuk keamanan input
    ACTION=$(gum choose "List Inventory" "Prune Runtimes" "Cancel" < /dev/tty)
    
    case "$ACTION" in
        "List"*)
            if command -v flatpak &>/dev/null; then
                flatpak list --app --columns=name,size,version | gum table
            else echo "Flatpak not found."; fi
            read -r < /dev/tty ;;
        "Prune"*)
            [ -x "$(command -v flatpak)" ] && flatpak uninstall --unused -y
            [ -x "$(command -v snap)" ] && sudo rm -rf /var/lib/snapd/cache/*
            gum style --foreground $COLOR_SEC "âœ” Done."; sleep 1 ;;
    esac
}

mod_config() {
    gum style --foreground $COLOR_PRI "ðŸ—‘ CONFIG CLEANER"
    cd "$HOME/.config" || return
    DIRS=$(find . -maxdepth 1 -type d -not -name '.' | sed 's|^\./||' | sort)
    
    if [ -z "$DIRS" ]; then echo "Empty."; sleep 1; return; fi

    TARGETS=$(echo "$DIRS" | gum choose --no-limit --height 10 --header "Select to DELETE:" < /dev/tty)
    
    if [ -n "$TARGETS" ]; then
        if gum confirm "Confirm delete?" < /dev/tty; then
            echo "$TARGETS" | while read -r DIR; do rm -rf "$HOME/.config/$DIR"; done
            gum style --foreground $COLOR_SEC "âœ” Deleted."
        fi
    fi
    cd "$HOME"
}

mod_disk() {
    gum style --foreground $COLOR_PRI "ðŸ“Š DISK ANALYZER"
    gum spin --title "Scanning..." -- find "$HOME" -type f -size +100M -not -path '*/.*' -exec du -ah {} + 2>/dev/null | sort -rh | head -n 10 > /tmp/bigfiles
    
    if [ -s /tmp/bigfiles ]; then
        cat /tmp/bigfiles | gum table --columns "SIZE,PATH"
        if gum confirm "Delete a file?" < /dev/tty; then
            F=$(gum input --placeholder "Path to delete" < /dev/tty)
            [ -f "$F" ] && rm "$F" && gum style --foreground $COLOR_SEC "âœ” Deleted."
        fi
    else
        echo "No large files."
    fi
    rm /tmp/bigfiles 2>/dev/null
    # Paksa read dari TTY agar tidak skip otomatis
    echo "Press Enter to continue..."
    read -r < /dev/tty
}

# --- [ MAIN LOOP (FIXED) ] ---

while true; do
    render_interface
    
    echo ""    
    gum style --foreground 8 "Select Operation Module:"
    
    ACTION=$(gum choose \
        "1. System Maintenance (Core)" \
        "2. Sandbox Manager (Flatpak/Snap)" \
        "3. Residual Config Cleaner" \
        "4. Disk Usage Analyzer" \
        "5. Exit Application" \
        < /dev/tty) 

    # Cek jika ACTION kosong (User tekan ESC atau Error)
    if [ -z "$ACTION" ]; then
        clear
        echo "Exiting..."
        exit 0
    fi

    case "$ACTION" in
        "1."*) mod_maintenance ;;
        "2."*) mod_sandbox ;;
        "3."*) mod_config ;;
        "4."*) mod_disk ;;
        "5."*) clear; exit 0 ;;
    esac
done
